name: Test Multi-Tier Container Actions

on:
  workflow_dispatch:
    inputs:
      containers:
        description: 'Containers to test (comma-separated or "all")'
        required: false
        default: 'content-generator,site-generator'
      skip-deployment:
        description: 'Skip deployment step'
        required: false
        default: 'true'
        type: boolean

permissions:
  contents: read
  id-token: write

jobs:
  test-actions:
    name: Test Container Actions
    runs-on: ubuntu-latest
    outputs:
      base-images: ${{ steps.build-bases.outputs.base-images-built }}
      service-containers: ${{ steps.build-services.outputs.containers-built }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Test Build Base Images Action
        id: build-bases
        uses: ./.github/actions/build-base-images

      - name: Test Build Service Containers Action
        id: build-services
        uses: ./.github/actions/build-service-containers
        with:
          containers: ${{ github.event.inputs.containers }}

      - name: Display Results
        run: |
          echo "[SUCCESS] Action Testing Complete!"
          echo ""
          echo "[BUILD] Base Images Built:"
          echo "${{ steps.build-bases.outputs.base-images-built }}"
          echo ""
          echo "[BUILD] Service Containers Built:"
          echo "${{ steps.build-services.outputs.containers-built }}"
          echo ""
          echo "[STATS] Build Summary:"
          echo "${{ steps.build-services.outputs.build-summary }}"

  test-deployment-action:
    name: Test Deployment Action (Dry Run)
    runs-on: ubuntu-latest
    needs: test-actions
    if: github.event.inputs.skip-deployment != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Simulate Azure Login
        run: |
          echo "[KEY] Would login to Azure with service principal..."
          echo "Note: This is a dry run - actual deployment skipped"

      - name: Test Deploy Action (Validation Only)
        run: |
          echo "[DEPLOY] Would deploy using ./.github/actions/deploy-to-azure"
          echo "[PACKAGE] Containers from previous job: ${{ needs.test-actions.outputs.service-containers }}"
          echo "[BUILD] Base images from previous job: ${{ needs.test-actions.outputs.base-images }}"
          echo ""
          echo "[PASS] Deployment action structure validated"
          echo "Note: Set skip-deployment=false and configure Azure credentials for actual deployment testing"
