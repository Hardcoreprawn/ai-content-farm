---
name: Optimized CI/CD Pipeline

'on':
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'

permissions:
  contents: read
  security-events: write
  pull-requests: write
  packages: write
  id-token: write

env:
  DOCKER_BUILDKIT: 1
  REGISTRY: ghcr.io
  REPOSITORY: hardcoreprawn/ai-content-farm

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    if: github.actor != 'dependabot[bot]'
    outputs:
      containers: ${{ steps.changes.outputs.containers }}
      infrastructure: ${{ steps.changes.outputs.infrastructure }}
      deploy-method: ${{ steps.changes.outputs.deploy-method }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 2

      - name: Detect Changes
        id: changes
        run: |
          changed_files=$(git diff --name-only HEAD~1 HEAD || echo "")
          containers="[]"
          infrastructure="false"
          deploy_method="skip"
          container_list=()

          while IFS= read -r file; do
            case "$file" in
              containers/*/*)
                container=$(echo "$file" | cut -d/ -f2)
                if [[ -f "containers/$container/Dockerfile" ]]; then
                  container_list+=("$container")
                fi
                ;;
              libs/*|requirements*.txt|pyproject.toml)
                for dir in containers/*/; do
                  container=$(basename "$dir")
                  if [[ -f "$dir/Dockerfile" ]]; then
                    container_list+=("$container")
                  fi
                done
                ;;
              infra/*|*.tf|*.tfvars)
                infrastructure="true"
                ;;
            esac
          done <<< "$changed_files"

          if [[ ${#container_list[@]} -gt 0 ]]; then
            containers=$(printf '%s\n' "${container_list[@]}" | \
                        sort -u | jq -R . | jq -s . | jq -c .)
          fi

          # Always run terraform to manage infrastructure state properly
          # Terraform plan will detect if there are actual changes to deploy
          deploy_method="terraform"

          {
            echo "containers=$containers"
            echo "infrastructure=$infrastructure"
            echo "deploy-method=$deploy_method"
          } >> "$GITHUB_OUTPUT"

  quality-checks:
    name: Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Lint Workflows
        uses: ./.github/actions/lint-workflows

      - name: Code Quality
        uses: ./.github/actions/code-quality

  security-infrastructure:
    name: Security Infrastructure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Infrastructure Security Scan
        uses: ./.github/actions/security-infrastructure
        with:
          fail-on-critical: 'false'

  security-containers:
    name: Security Containers
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Container Security Scan
        uses: ./.github/actions/security-containers
        with:
          fail-on-critical: 'false'
          scan-mode: 'dockerfile'

  security-code:
    name: Security Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Code Security Scan
        uses: ./.github/actions/security-code
        with:
          fail-on-critical: 'false'

  terraform-checks:
    name: Terraform Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Terraform Quality
        uses: ./.github/actions/infrastructure-quality
        with:
          infra-changed: 'true'

      - name: Cost Analysis
        uses: ./.github/actions/cost-analysis
        with:
          infracost-api-key: ${{ secrets.INFRACOST_API_KEY }}

  test-containers:
    name: Test ${{ matrix.container }}
    runs-on: ubuntu-latest
    needs: [quality-checks, security-infrastructure, security-containers, security-code]
    strategy:
      matrix:
        container: [content-collector, content-processor, site-generator]
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Test Container
        uses: ./.github/actions/test-single-container
        with:
          container-name: ${{ matrix.container }}
          test-type: unit

  build-containers:
    name: Build ${{ matrix.container }}
    runs-on: ubuntu-latest
    needs: [test-containers]
    if: |
      always() &&
      needs.test-containers.result == 'success'
    strategy:
      matrix:
        container: [content-collector, content-processor, site-generator]
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push
        uses: ./.github/actions/build-and-push-container
        with:
          container-name: ${{ matrix.container }}
          registry: ${{ env.REGISTRY }}
          repository: ${{ env.REPOSITORY }}
          tag: ${{ github.sha }}

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: [detect-changes, build-containers, terraform-checks, security-infrastructure, security-containers, security-code]
    if: |
      always() &&
      github.ref == 'refs/heads/main' &&
      needs.build-containers.result == 'success' &&
      needs.terraform-checks.result == 'success' &&
      needs.security-infrastructure.result == 'success' &&
      needs.security-containers.result == 'success' &&
      needs.security-code.result == 'success'
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.2

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy
        uses: ./.github/actions/smart-deploy
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}
          environment: production
          deployment-method: ${{ needs.detect-changes.outputs.deploy-method }}
          terraform-storage-account: ${{ vars.TERRAFORM_STATE_STORAGE_ACCOUNT_PROD }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          image-tag: ${{ github.sha }}

  security-container-images:
    name: Security Container Images
    runs-on: ubuntu-latest
    needs: [build-containers]
    if: |
      always() &&
      needs.build-containers.result == 'success'
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Login to Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Container Image Security Scan
        uses: ./.github/actions/security-containers
        with:
          fail-on-critical: 'false'
          scan-mode: 'image'
          registry: ${{ env.REGISTRY }}
          repository: ${{ env.REPOSITORY }}
          image-tag: ${{ github.sha }}

  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs:
      - detect-changes
      - quality-checks
      - security-infrastructure
      - security-containers
      - security-code
      - security-container-images
      - terraform-checks
      - test-containers
      - build-containers
      - deploy
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "# Pipeline Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "Complete!" >> "$GITHUB_STEP_SUMMARY"
