name: 'Checkov Infrastructure Scan'
description: 'Run Checkov infrastructure security scanning'
inputs:
  workspace-path:
    description: 'Path to the workspace'
    required: true
    default: ${{ github.workspace }}

runs:
  using: 'composite'
  steps:
    - name: Create Security Results Directory
      shell: bash
      run: mkdir -p security-results

    - name: Check for Infrastructure Code
      id: check-infra
      shell: bash
      run: |
        if [ -d "infra" ] && find infra -name "*.tf" -type f | grep -q .; then
          echo "found=true" >> "$GITHUB_OUTPUT"
        else
          echo "found=false" >> "$GITHUB_OUTPUT"
          echo "No Terraform files found in infra/, skipping Checkov scan"
        fi

    - name: Run Checkov Infrastructure Security Scan
      if: steps.check-infra.outputs.found == 'true'
      shell: bash
      env:
        WORKSPACE_PATH: ${{ inputs.workspace-path }}
      run: |
        echo "Running Checkov infrastructure security scan..."
        docker run --rm -v "$WORKSPACE_PATH":/workspace \
          bridgecrew/checkov:latest -d /workspace/infra \
          --framework terraform \
          --output json \
          --output-file-path /workspace \
          --file security-results/checkov-results.json || true

    - name: Upload Checkov Results
      if: steps.check-infra.outputs.found == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: security-results-checkov
        path: security-results/checkov-results.json
        retention-days: 30
        if-no-files-found: warn
