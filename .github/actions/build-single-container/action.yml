name: 'Build Single Container (Optimized)'
description: 'Builds a single service container with optimized caching for speed'
inputs:
  container-name:
    description: 'Name of the container to build'
    required: true
  registry:
    description: 'Container registry to tag images for (optional)'
    required: false
    default: ''
  enable-cache:
    description: 'Enable Docker layer caching'
    required: false
    default: 'true'
outputs:
  build-result:
    description: 'Build result: success or failure'
    value: ${{ steps.build.outputs.result }}
  image-tag:
    description: 'Full image tag that was built'
    value: ${{ steps.build.outputs.image-tag }}

runs:
  using: 'composite'
  steps:
    - name: Build Container (Optimized)
      id: build
      shell: bash
      env:
        CONTAINER_NAME: ${{ inputs.container-name }}
        ENABLE_CACHE: ${{ inputs.enable-cache }}
        REGISTRY: ${{ inputs.registry }}
      run: |
        echo "[BUILD] Building container: $CONTAINER_NAME (optimized for speed)"

        container_dir="containers/$CONTAINER_NAME"
        dockerfile_path="$container_dir/Dockerfile"

        # Verify files exist
        if [ ! -d "$container_dir" ]; then
          echo "[ERROR] Container directory not found: $container_dir"
          echo "result=failure" >> $GITHUB_OUTPUT
          exit 1
        fi

        if [ ! -f "$dockerfile_path" ]; then
          echo "[ERROR] Dockerfile not found: $dockerfile_path"
          echo "result=failure" >> $GITHUB_OUTPUT
          exit 1
        fi

        # Build image with optimized caching
        image_tag="$CONTAINER_NAME:latest"
        echo "[BUILD] Building image: $image_tag"

        # Configure aggressive caching for speed
        build_args="--cache-from=type=gha --cache-to=type=gha,mode=max"

        if [ "$ENABLE_CACHE" = "false" ]; then
          build_args="--no-cache"
        fi

        echo "[INFO] Using Docker BuildKit with caching: $build_args"

        if docker build $build_args -f "$dockerfile_path" -t "$image_tag" .; then
          echo "[PASS] $CONTAINER_NAME built successfully"

          # Tag for registry if provided
          if [ -n "$REGISTRY" ]; then
            registry_tag="$REGISTRY/$image_tag"
            docker tag "$image_tag" "$registry_tag"
            echo "[INFO] Tagged for registry: $registry_tag"
            echo "image-tag=$registry_tag" >> $GITHUB_OUTPUT
          else
            echo "image-tag=$image_tag" >> $GITHUB_OUTPUT
          fi

          # Clean up local image (keep if registry provided for potential push)
          if [ -z "$REGISTRY" ]; then
            docker rmi "$image_tag" || true
            echo "[CLEANUP] Removed local image to save space"
          fi

          echo "result=success" >> $GITHUB_OUTPUT
        else
          echo "[FAIL] $CONTAINER_NAME build failed"
          echo "result=failure" >> $GITHUB_OUTPUT
          exit 1
        fi
